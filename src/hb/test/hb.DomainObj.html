<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

    <title>hb-app test</title>

    <script src="../../../bower_components/webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../../bower_components/web-component-tester/browser.js"></script>
    <script src="../../../bower_components/test-fixture/test-fixture-mocha.js"></script>
    
    <link rel="import" href="../hb.DomainObj.html">
  </head>
  <body>

    <script>
      
      const clone = obj => JSON.parse(JSON.stringify(obj));

      hb.testDoc = class extends hb.DomainObj {
          static get is() { return "testDoc"; }
      }

      hb.testRefDoc = class extends hb.DomainObj {
        static get is() { return "testRefDoc"; }
      }


      class MockDb{
        constructor({snapshotData = null, update = null}) {
          const noop = () => {};
          this.snapshotData = snapshotData || noop;
          this.update = update || noop;
        }

        // returns a docRef
        doc(path) {
          return {
            get: () => {
              return Promise.resolve({
                data: () => {
                  return this.snapshotData(path);
                },
                exists: true
              });
            },
            update: (doc) => {
              return Promise.resolve(this.update(path, doc));
            }
          };
        }
      }
      


      describe("hb.DomainObj", () => {
        let db = null;

          const testDispatchEventDocData = {
            title: "TestDispatchEvent",
            referencedBy: {
              "docs/TestHandleEvent": {
                is: "TestHandleEvent",
                events: {
                  "": ["some-event", "notcalled-event"]
                }
              }
            }
          };

          const testHandleEventData = {
            title: "TestHandleEvent"
          };

          hb.TestDispatchEvent = class extends hb.DomainObj {
            static get is() { return "TestDispatchEvent"; }
            doSomethingThatDispatchesAnEvent() {
              this.progressTracker = new ProgressTracker();
              return this.update(doc => {
                this.dispatchDomainEvent("some-event");
                return doc;
              }, this.progressTracker);
            }
          }

          hb.TestHandleEvent = class extends hb.DomainObj {
            static get is() { return "TestHandleEvent"; }
            static get events() {
              return {
                "some-event": "_someEvent",
                "notcalled-event": "_notCalledEvent"
              }
            }
            _someEvent(doc, refDoc) {
              return doc;
            }
            _notCalledEvent(doc, refDoc) {}
          }

          beforeEach(() => {
            db = new MockDb({
              snapshotData: (path) => {
                if (path === "docs/TestDispatchEvent") {
                  return testDispatchEventDocData;
                } else if (path === "docs/TestHandleEvent") {
                  return testHandleEventData;
                }
              },
              update: (path, doc) => {}
            });
          })




        it("exists", () => {
          expect(hb.DomainObj).not.to.be.null;
        });

        it("can be created", () => {
          const obj = new hb.DomainObj({db});
          expect(obj).not.to.be.null;          
        });

        it("forces is to exist", () => {
          const isNotDefined = () => {
            return hb.DomainObj.is;
          };
          expect(isNotDefined).to.throw("is is not defined");
        });



        describe("_updateReferences", () => {
          var testDoc, mockDb;

          beforeEach(() => {
            testDoc = clone({
              "references": {
                "somedb/path": {
                  "is":"test-object",
                  "events":{
                    "": ["test-event", "test-event2"]
                  }
                }
              }
            });
          });




          describe("add listener", () => {
            
            it("can add a listener", () => {
              const obj = new hb.DomainObj({db});
              obj.addDomainEventListener("somedb/path", "test-object", "test-event");
              obj.addDomainEventListener("somedb/path", "test-object", "test-event2");
              const newObj = obj._updateReferences({});
              expect(newObj).to.deep.equal(testDoc);
            });

            it("keeps listeners unique", () => {
              const obj = new hb.DomainObj({db});
              obj.addDomainEventListener("somedb/path", "test-object", "test-event");
              obj.addDomainEventListener("somedb/path", "test-object", "test-event");
              const newObj = obj._updateReferences(testDoc);
              expect(newObj).to.deep.equal(testDoc);
            });

            it("can add multiple listeners", () => {
              const obj = new hb.DomainObj({db});
              obj.addDomainEventListener("somedb/path", "test-object", "test-event2");             
              const expected = clone(testDoc);
              expected.references["somedb/path"].events[""] = ["test-event", "test-event2"];
              const newObj = obj._updateReferences(testDoc);
              expect(newObj).to.deep.equal(expected);
            });

            it("can add a scoped listener", () => {
              const obj = new hb.DomainObj({db});
              obj.addDomainEventListener("somedb/path", "test-object", "test-scoped-event", "testScope");
              const expected = clone(testDoc);
              expected.references["somedb/path"].events["testScope"] = ["test-scoped-event"];
              const newObj = obj._updateReferences(testDoc);
              expect(newObj).to.deep.equal(expected);
            });
          });




          describe("remove listener", () => {

            it("can remove a listner", () => {
              const obj = new hb.DomainObj({db});
              obj.removeDomainEventListener("somedb/path", "test-event");
              expect(testDoc.references["somedb/path"].events[""].length).to.be.equal(2);              
              const newObj = obj._updateReferences(testDoc);
              expect(newObj.references["somedb/path"]).to.be.undefined;
            });
            
            it("removes the reference if no event", () => {
              const obj = new hb.DomainObj({db});
              obj.removeDomainEventListener("somedb/path");
              expect(testDoc.references["somedb/path"].events[""].length).to.be.equal(2);              
              const newObj = obj._updateReferences(testDoc);
              expect(newObj.references["somedb/path"]).to.be.undefined;
            });
            
            it("removes a listener from a scope", () => {
              const obj = new hb.DomainObj({db});
              obj.removeDomainEventListener("somedb/path", "some-event", "scoped");
              testDoc.references["somedb/path"].events["scoped"] = ["some-event"];
              expect(testDoc.references["somedb/path"].events["scoped"].length).to.be.equal(1);              
              const newObj = obj._updateReferences(testDoc);
              expect(newObj.references["somedb/path"]).to.be.undefined;
            });


            // not a real use case?
            // it("removes all listener from a scope", () => {
            //   const obj = new hb.DomainObj({db});
            //   obj.removeDomainEventListener(null, "somedb/path", "scoped");
            //   testDoc.references["somedb/path"].events["scoped"] = ["some-event"];
            //   expect(testDoc.references["somedb/path"].events["scoped"].length).to.be.equal(1);              
            //   const newObj = obj._updateReferences(testDoc);
            //   expect(newObj.references["somedb/path"].events).to.be.undefined;
            // });
          });       

        });



        describe("update", () => {

          it ("calls the update callback with an updated document", (done) => {
            const db = new MockDb({
              snapshotData: (dbPath) => {
                return {foo: "bar"};
              },
              update: (dbPath, doc) => {}
            });
            const testDoc = new hb.testDoc({db, dbPath: "docs/testDoc"});
            
            testDoc.update(doc => {
              doc.foo = "baz";
              return doc;
            }).then(doc => {
              expect(doc.foo).to.be.equal("baz");
              done();
            });
          });


          it ("calls the update callback with an undefined document if not updated", (done) => {
            const db = new MockDb({
              snapshotData: (dbPath) => {
                return {foo: "bar"};
              },
              update: (dbPath, doc) => {}
            });
            const testDoc = new hb.testDoc({db, dbPath: "docs/testDoc"});
            
            testDoc.update(doc => {
              doc.foo = "baz";
              // no return statement here
            }).then(doc => {
              expect(doc).to.be.undefined;
              done();
            });
          });
        });


        describe("references", () => {
          it ("adds references with addEventListener", (done) => {
            const db = new MockDb({
              snapshotData: dbPath => { return {}; },
              update: (dbPath, doc) => {
                if (dbPath === "docs/testDoc") {
                  expect(doc.references["docs/testRefDoc"].events[""][0]).to.be.equal("test-event");
                  done();
                }
              }
            });

            const testDoc = new hb.testDoc({db, dbPath: "docs/testDoc"});            
            testDoc.update(doc => {
              testDoc.addDomainEventListener("docs/testRefDoc", "testRefDoc", "test-event");
              return doc;
            });
          });

          it ("adds referencedBy with addEventListener", (done) => {
            const db = new MockDb({
              snapshotData: dbPath => { return {}; },
              update: (dbPath, doc) => {
                if (dbPath === "docs/testRefDoc") {
                  expect(doc.referencedBy["docs/testDoc"].events[""][0]).to.be.equal("test-event");
                  done();
                }
              }
            });

            const testDoc = new hb.testDoc({db, dbPath: "docs/testDoc"});            
            testDoc.update(doc => {
              testDoc.addDomainEventListener("docs/testRefDoc", "testRefDoc", "test-event");
              return doc;
            });
          });
        });



        describe("events", () => {        

          it("can dispatch an event", async () => {
            const dbPath = "docs/TestDispatchEvent";
            const doc = new hb.TestDispatchEvent({db, dbPath});            
            const someEventSpy = sinon.spy(hb.TestHandleEvent.prototype, "_someEvent");
            const notcalledEventSpy = sinon.spy(hb.TestHandleEvent.prototype, "_notCalledEvent");

            await doc.doSomethingThatDispatchesAnEvent();
            expect(someEventSpy.calledOnce).to.be.true;
            expect(notcalledEventSpy.notCalled).to.be.true;
            someEventSpy.restore();
            notcalledEventSpy.restore();
          });
          
          it ("updates the referenced doc if the event handler returns a doc", async () => {
            const dbPath = "docs/TestDispatchEvent";
            const doc = new hb.TestDispatchEvent({db, dbPath});
            const updateSpy = sinon.spy(db, "update");

            await doc.doSomethingThatDispatchesAnEvent();            
            expect(updateSpy.calledTwice).to.be.true;
            expect(updateSpy.getCall(0).args[0]).to.be.equal("docs/TestDispatchEvent");
            expect(updateSpy.getCall(1).args[0]).to.be.equal("docs/TestHandleEvent");
          });

          // if _someEvent returns a doc update is called          
          it ("does not update the referenced doc if the event handler does not return a doc", async () => {
            const dbPath = "docs/TestDispatchEvent";
            const doc = new hb.TestDispatchEvent({db, dbPath});
            const updateSpy = sinon.spy(db, "update");
            const someEventStub = sinon.stub(hb.TestHandleEvent.prototype, "_someEvent", (doc, docRef) => {
              return null;
            });            

            await doc.doSomethingThatDispatchesAnEvent();            
            expect(updateSpy.calledOnce).to.be.true;
            expect(updateSpy.getCall(0).args[0]).to.be.equal("docs/TestDispatchEvent");
            someEventStub.restore();
          });
        });


        describe("progressTracker", () => {
          it("Provides a description", async () => {
            const dbPath = "docs/TestDispatchEvent";
            const doc = new hb.TestDispatchEvent({db, dbPath});
            await doc.doSomethingThatDispatchesAnEvent();
            expect(doc.progressTracker.stepsDescription).to.be.equal("Update: Loading document, Update: Updating, Update: Updating references, Update: Dispatching events, Handling events for docs/TestHandleEvent: Loading document, Handling events for docs/TestHandleEvent: Updating document, Handling events for docs/TestHandleEvent: Dispatching events, Handling events for docs/TestHandleEvent: Finished handling events, Update: Document updated");
          });
        });
      });
    </script>
  </body>
</html>
