<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

    <title>hb-app test</title>

    <script src="../../../bower_components/webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../../bower_components/web-component-tester/browser.js"></script>
    <script src="../../../bower_components/test-fixture/test-fixture-mocha.js"></script>
    
    <link rel="import" href="../ProgressTracker.html">
  </head>
  <body>

    <script>
      describe("ProgressTracker", () => {

        it("exists", () => {
          expect(ProgressTracker).not.to.be.null;
        });

        it("can be created", () => {
          const tracker = new ProgressTracker();
          expect(tracker).not.to.be.null;
        });

        it("can create a layer with steps", () => {
          const tracker = new ProgressTracker();
          tracker.addLayer("Test", 2);
          expect(tracker.totalSteps).to.equal(2);
        });

        it("notifies when creating a layer", () => {
          const tracker = new ProgressTracker(update => {
            expect(update.max).to.equal(2);
          });
          tracker.addLayer("Test", 2);
        });

        describe("layer", () => {
          it("can add steps", () => {
            let count = 0;
            const tracker = new ProgressTracker(update => {
              count = count + 1;
              switch(count) {
                case 1:
                  expect(update.max).to.equal(2);
                  break;
                case 2: 
                  expect(update.max).to.equal(5);
                  break;
              }
            });
            const layer = tracker.addLayer("Test", 2);
            layer.addSteps(3);
          });

          it("can call next", () => {
            let count = 0;
            const tracker = new ProgressTracker(update => {
              count = count + 1;
              switch(count) {
                case 1:
                  expect(update.max).to.equal(2);
                  break;
                case 2: 
                  expect(update.description).to.equal("Test: step 1");
                  break;
              }
            });
            const layer = tracker.addLayer("Test", 2);
            layer.next("step 1");
          });

          it("does not add more steps then defined", () => {
            let count = 0;
            const tracker = new ProgressTracker(update => {
              count = count + 1;
              switch(count) {
                case 1:
                  expect(update.max).to.equal(2);
                  break;
                case 2: 
                  expect(update.description).to.equal("Test: step 1");
                  break;
              }
            });
            const layer = tracker.addLayer("Test", 2);
            layer.next("step 1");
            layer.next("step 2");
            layer.next("step 3");
            expect(tracker.description).to.equal("Test: step 1, Test: step 2");
          });

          it("can call done", () => {
            let count = 0;
            const tracker = new ProgressTracker(update => {
              count = count + 1;
              switch(count) {
                case 1:
                  expect(update.max).to.equal(5);
                  break;
                case 2: 
                  expect(update.description).to.equal("Test: step 1");
                  break;
              }
            });
            const layer = tracker.addLayer("Test", 5);
            layer.next("step 1");
            expect(tracker.totalSteps).to.equal(5);            
            layer.done("done");
            expect(tracker.description).to.equal("Test: step 1, Test: done");
            expect(tracker.totalSteps).to.equal(2);
          });

          it("can call error", () => {
            let count = 0;
            const tracker = new ProgressTracker(update => {
              count = count + 1;
              switch(count) {
                case 1:
                  expect(update.max).to.equal(5);
                  break;
                case 2: 
                  expect(update.description).to.equal("Test: step 1");
                  break;
              }
            });
            const layer = tracker.addLayer("Test", 5);
            layer.next("step 1");
            expect(tracker.totalSteps).to.equal(5);            
            layer.error({message: "An error occurred."});
            expect(tracker.description).to.equal("Test: step 1, Error: An error occurred.");
            expect(tracker.totalSteps).to.equal(2);
          });
        });

        describe("multiple layers", () => {
          it("can track multiple layers", () => {
            let count = 0;
            const tracker = new ProgressTracker(update => {
              count = count + 1;
              switch(count) {
                case 1:
                  expect(update.max).to.equal(5);
                  break;
                case 2: 
                  expect(update.max).to.equal(8);
                  break;
              }
            });
            const layer = tracker.addLayer("Test", 5);
            const layer2 = tracker.addLayer("Test2", 3);
          });

          it("can handle next for multiple layers", () => {
            let count = 0;
            const tracker = new ProgressTracker(update => {
              count = count + 1;
              switch(count) {
                case 1:
                  expect(update.max).to.equal(5);
                  break;
                case 2: 
                  expect(update.max).to.equal(8);
                  break;
              }
            });
            const layer = tracker.addLayer("Test", 5);
            const layer2 = tracker.addLayer("Test2", 3);
            layer.next("one");
            layer2.next("two");
            layer.next("three");
            layer2.next("four");            
           
            expect(tracker.description).to.equal("Test: one, Test2: two, Test: three, Test2: four");
          });

        it("can handle done for multiple layers", () => {
            let count = 0;
            const tracker = new ProgressTracker(update => {
              count = count + 1;
              switch(count) {
                case 1:
                  expect(update.max).to.equal(5);
                  break;
                case 2: 
                  expect(update.max).to.equal(8);
                  break;
              }
            });
            const layer = tracker.addLayer("Test", 5);
            const layer2 = tracker.addLayer("Test2", 3);
            layer.next("one");
            layer2.next("two");
            layer.next("three");
            layer2.next("four");
            layer.done("done");
            expect(tracker.description).to.equal("Test: one, Test2: two, Test: three, Test2: four, Test: done");
            expect(tracker.totalCount).to.be.equal(6);
          });
        });
      });
    </script>
  </body>
</html>
