<script>
var hb = window.hb || {};


/**
 * Base class for all domain objects.
 */
hb.domainObj  = class {
    static get is() { 
        throw new Error("doc.is not defined");
    }

    constructor({db, dbPath}) {
        this.db = db;
        this.dbPath = dbPath;
        this.docRef = db.doc(dbPath);
        this._listenersToHandle = [];
        this._eventsToHandle = [];
    }
    
    /**
     * Supports api method updates
     * @param update
     * A method that recieves its document which can make changes to
     * and return the document.
     * The method can make calls to dispatchEvent, addEventListener, and  removeEventListener.
     * @returns Object
     * The document data to update.
     */
    update(update) {        
        return this.docRef.get().then(event => {
            const doc = event.data();
            let newDoc = update(doc);
            newDoc = this._updateReferences(newDoc);
            return this.docRef.update(newDoc)
                .then(_ => this._updateReferencedBy(newDoc))
                .then(doc => this._handleEvents(doc));
        });
    }

    _updateReferences(doc) {
        // syncronous 
        // add references using _listenersToHandle
        // return the doc
    }

    _updateReferencedBy(doc) {
        // needs to be a promise
        // load all objects and add references to them
        // then clear the _listenersToHandle
        // return the new doc
    }

    _handleEvents(doc) {
        if (!doc.referencedBy) {
            return Promise.resolve();
        }

        // notify objects of a reference change
        Object.keys(doc.referencedBy).forEach(key => {
            const reference = doc.referencedBy[key];
            const staticDomainObj = hb[reference.is];
            const domainObjEvents = staticDomainObj.events;


            // if the doc does not exist then remove the reference

            // test first if the document has anything to update

            // if reference.events.keys match any domainObjEvents then we need to load that document
            const docRef = this.db.doc(key);
            const domainObj = new hb[reference.is](this.db);
            docRef.get(event => {
                const referenceDoc = event.data();
                // call each event handler -> which could add to _eventsToHandle
                domainObj[handler](doc);
                // now domainObj may have _eventsToHandle

                // this means this method should be on the document handleEvents OR _handleEvents
                docRef.update(referenceDoc);

            });
            // after all events are fired call
            // domainObj._handleEvents();


        });        
    }

    dispatchEvent(event) {
        this._eventsToHandle.push(event);
    }

    addEventListener(event, dbPath, is, reason) {
        _listenersToHandle.push({add: true, event, dbPath, is, reason});
    }

    removeEventListener(event, dbPath, is, reason) {
        _listenersToHandle.push({remove: true, event, dbPath, is, reason});
    }
}

/**
 * Base class for document objects.
 */
hb.doc = class extends hb.domainObj {     
    constructor({db, docId}) {
        super({db, dbPath: `doc/${docId}`})
    }
}


hb["hb-doc"] = class extends hb.doc {
    static get is() { return "hb-doc"; }

    static get eventsReson() {
        return "artwork";
    }

    static get events() {
        return {
            "thumbnail-changed": "_arworkThumbnailChanged",
            "description-changed": {
                reason: "artwork",
                handler: "_artworkDescriptionChanged"
            },
            "something-happened": {
                reson: "",
                handler: "_somethingHappened"
            }
        };
    }

    _arworkThumbnailChanged(doc, refDoc) {
        // update and return doc
        // should this return wether or not anything was changed?
        //      could do this by returning a falsy value other than a promise.
        //      this would allow the shortcutting of the update call as well as the _handleEvents call
        // call this.dispatchEvent if needed
    }
}

</script>