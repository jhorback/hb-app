<link rel="import" href="hb.html">
<link rel="import" href="hb.config.html">
<link rel="import" href="hb.db.html">
<script>
/*
 *
 */
hb.DocumentCreator = class {
    constructor(db) {
        this.db = db || hb.db();
    }

    static getDocumentId(route, title) {
        return `${route}-${encodeURIComponent(title.split(" ").join("-").replace(/[^a-z0-9]/gi, "-").toLowerCase())}`;
    }

    async _getDocId(docId, progressTracker) {
        const progressLayer = progressTracker.addLayer("_getDocId", 2);
        progressLayer.next(`Checking id ${docId}`);
        const snapshot = await this.db.doc(`doc/${docId}`).get();
        if (snapshot.exists) {
            progressLayer.done("Id exists...");
            return await this._getDocId(`${docId}-`, progressTracker);
        } else {
            progressLayer.done("Id found");
            return docId;
        }
    }

    async createDocument(is, title, progressTracker) {
        const config = hb.config.current();
        const docType = config.docTypes.find(dt => dt.is === is);
        const doc = hb[is].defalutValue;
        const progressLayer = progressTracker.addLayer("Creating document", 3);
        progressLayer.next("Getting id");
        try {
            const docId = await this._getDocId(
                hb.DocumentCreator.getDocumentId(docType.route, title),
                progressTracker);
            progressLayer.next("Creating document");
            await this.db.doc(`doc/${docId}`).set(doc);
            progressLayer.done("Document created");
            return { docId, doc };
        } catch (error) {
            progressLayer.error(error);
        }        
    }
}

</script>