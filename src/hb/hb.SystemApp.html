<link rel="import" href="hb.html">
<link rel="import" href="hb.DomainObj.html">
<link rel="import" href="hb.DocumentCreator.html">
<script>
/**
 * Base class for doc documents
 */
hb.SystemApp = class extends hb.DomainObj {     
    constructor({db}) {
        super({db, dbPath: "system/app"})
    }

    static get events() {
        return {		
            "title-changed": {
                "homeDoc": "_homeDocTitleChanged",
                "menuItem": "_menuItemTitleChanged"
            }
	    };
	}


    /**
     * Creates the document and adds it as the System.App.homeDoc.
     * @returns {app, docId, doc}
     */
    async createHomePage({is, title, progressTracker}) {
        const progressLayer = progressTracker.addLayer("Updating application", 3);
        progressLayer.next("Updating");

        try {     
            const docCreator = new hb.DocumentCreator();

            // create the document
            const { docId, doc } = await docCreator.createDocument(is, title, progressTracker);
            const app = await this.update(app => {
                progressLayer.next("Saving");
                this._setHomePage(app, doc);
                return app;            
            }, progressTracker);
            progressLayer.done("Home page created");
            return {app, docId, doc};

        } catch (error) {
            progressLayer.error(error);
        }
    }


    async setHomePage({doc, progressTracker}) {
        const progressLayer = progressTracker.addLayer("Updating application", 3);
        progressLayer.next("Updating");

        try {
            const app = await this.update(app => {
                progressLayer.next("Saving");
                if (app.homeDoc.docId) {
                    this.removeEventListener("title-changed", `docs/${app.homeDoc.docId}`, "homeDoc");
                }
                this._setHomePage(app, doc);
                return app;            
            }, progressTracker);
            progressLayer.done("Home page created");
            return app;
        } catch(error) {
            progressLayer.error(error);
        }
    }

    _setHomePage(app, doc) {
        app.homeDoc = {
            docId: doc.docId,
            is: doc.is,
            title: doc.title
        };
        this.addEventListener("title-changed", `docs/${doc.docId}`, doc.is, "homeDoc");
    }

    /**
     * Removes the home page
     * @returns app
     */
    async removeHomePage(progressTracker) {
        const progressLayer = progressTracker.addLayer("Updating application", 3);
        progressLayer.next("Updating");

        try {
            const app = await this.update(app => {
                if (app.homeDoc && app.homeDoc.docId) {
                    progressLayer.next("Saving");
                    this.removeEventListener("title-changed", `docs/${app.homeDoc.docId}`, "homeDoc");
                    app.homeDoc = {};
                    return app;
                }
                progressLayer.next("No need to save");
            }, progressTracker);
            progressLayer.done("Home page removed");
            return app;

        } catch (error) {
            progressLayer.error(error);
        }
    }

    async createMenuPage({is, title, progressTracker}) {
        const progressLayer = progressTracker.addLayer("Updating application", 3);
        progressLayer.next("Updating");

        try {     
            const docCreator = new hb.DocumentCreator();

            // create the document
            const { docId, doc } = await docCreator.createDocument(is, title, progressTracker);
            const app = await this.update(app => {
                progressLayer.next("Saving");
                this._addMenuItem(app, doc);
                return app;            
            }, progressTracker);
            progressLayer.done("Home page created");
            return {app, docId, doc};

        } catch (error) {
            progressLayer.error(error);
        }
    }

    async addMenuItem({doc, progressTracker}) {
        const progressLayer = progressTracker.addLayer("Updating application", 3);
        progressLayer.next("Updating");

        try {
            const app = await this.update(app => {
                progressLayer.next("Saving");
                this._addMenuItem(app, doc);
                return app;            
            }, progressTracker);
            progressLayer.done("Menu item added");
            return app;

        } catch (error) {
            progressLayer.error(error);
        }
    }

    async removeMenuItem({docId, progressTracker}) {
        const progressLayer = progressTracker.addLayer("Updating application", 3);
        progressLayer.next("Updating");

        try {
            const app = await this.update(app => {
                progressLayer.next("Saving");                
                const itemIndex = app.menu.findIndex(i => i.docId === docId);
                const deletedItem = app.menu.splice(itemIndex, 1)[0];
                this.removeEventListener("title-changed", `docs/${deletedItem.docId}`, "menuItem");                 
                return app;
            }, progressTracker);
            progressLayer.done("Menu item removed");
            return app;

        } catch (error) {
            progressLayer.error(error);
        }
    }

    async moveMenuItem({docId, up, down, progressTracker}) {
        const progressLayer = progressTracker.addLayer("Updating application", 3);
        progressLayer.next("Updating");

        try {
            const app = await this.update(app => {
                progressLayer.next("Saving");                
                const itemIndex = app.menu.findIndex(i => i.docId === docId);
                const item = app.menu.splice(itemIndex, 1)[0];
                const newIndex = up ? itemIndex - 1 : itemIndex + 1;
                app.menu.splice(newIndex, 0, item);
                return app;
            }, progressTracker);
            progressLayer.done("Menu item moved");
            return app;

        } catch (error) {
            progressLayer.error(error);
        }
    }

    _addMenuItem(app, doc) {
        app.menu = app.menu || [];
        app.menu.push({
            docId: doc.docId,
            is: doc.is,
            title: doc.title,
            url: hb[doc.is].getUrl(doc.docId)
        });
        this.addEventListener("title-changed", `docs/${doc.docId}`, doc.is, "menuItem");        
    }

    _homeDocTitleChanged(doc, refDoc) {
        throw new Error("Not implemented");
    }

    _menuItemTitleChanged(doc, refDoc) {
        throw new Error("Not implemented");
    }
}
</script>