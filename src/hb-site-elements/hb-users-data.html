<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../hb/hb.html">
<link rel="import" href="../hb-app/EventMap.html">
<script>
/**
 * @customElement
 * @polymer
 */
class HbUsersData extends Polymer.FirestoreMixin(EventMap(Polymer.Element)) {
    static get is() { return 'hb-users-data'; }

    static get properties() {
        return {
            users: {
                type: Array,
                notify: true,
                collection: "users",
                value: [],
                live: true
            },
            usersReady: {
                type: Boolean,
                observer: "_usersReadyChanged"
            },
            usersState: {
                type: Object,
                notify: true,
                value: {
                    isReady: false,
                    showUnregistered: false,
                    filteredUsers: [],
                    noUsersMessage: ""
                }
            }
        };
    }

    static get eventsListenAt() {
        return "parent";
    }
    
    static get events() {
        return {
            "filter-changed": "_filterChanged"
        };
    }

    _usersReadyChanged(currentValue, oldValue) {        
        this.set("usersState.isReady", this.usersReady);
        if (this.usersReady) {
            this._filterUsers();
        }
    }

    _filterChanged(event) {
        const {showUnregistered} = event.detail;
        this.set("usersState.showUnregistered", showUnregistered);
        this._filterUsers();
    }

    _filterUsers() {
        const {showUnregistered} = this.usersState;
        const users = this.users.reduce((users, user) => {
            if (!user.isRegistered === showUnregistered) {
                users.push(user);
            }
            return users;
        }, []);

       const noUsersMessage = users.length !== 0 ? "" :
                showUnregistered ? "There are no unregistered users" :
                "There are no registered users";
        this.set("usersState.noUsersMessage", noUsersMessage);
        this.set("usersState.filteredUsers", users);
    }
}

window.customElements.define(HbUsersData.is, HbUsersData);
</script>
